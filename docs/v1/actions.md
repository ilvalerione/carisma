# Actions

[TOC]

Carisma actions allow you to perform custom tasks on one or more Eloquent models. For example, you might write an action that sends an email to a user containing account data they have requested. Or, you might write an action to transfer a group of records to another user.

## Define Action

Carisma actions may be generated using the `carisma:action` Artisan command. By default, all actions are placed in the `app/Carisma/Actions` directory:


```shell
php artisan carisma:action EmailAccountProfile
```

In this example, we'll define an action that sends an email message to a user or group of users:

```php
<?php

namespace App\Carisma\Actions;

use Illuminate\Bus\Queueable;
use Carisma\Actions\Action;
use Illuminate\Queue\SerializesModels;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Contracts\Queue\ShouldQueue;

class EmailAccountProfile extends Action
{
    use InteractsWithQueue, Queueable, SerializesModels;

    /**
     * Perform the action on the given models.
     *
     * @param  \Carisma\Http\Requests\ActionRequest  $request
     * @param  \Illuminate\Support\Collection  $models
     * @return mixed
     */
    public function run($request, $models)
    {
        foreach ($models as $model) {
            (new AccountData($model))->send();
        }
    }
}
```

The `run` method receives the current request instance, as well as a collection of selected models. The `run`method **always** receives a `Collection` of models, even if the action is only being performed against a single model.

Within the `run` method, you may perform whatever tasks are necessary to complete the action. You are free to update database records, send emails, call other services, etc. The sky is the limit!

## Registering Action

Once you have defined an action, you are ready to attach it to a resource. Each resource generated by Carisma contains a `actions` method. To attach an action to a resource, you should simply add it to the array of actions returned by this method:

```php
/**
 * Get the actions available for the resource.
 *
 * @param  \Illuminate\Http\Request $request
 * @return array
 */
public static function actions(Request $request)
{
    return [
        new EmailAccountProfile,
    ];
}
```

## Run Action

You can run the action using endpoint `/{resource}/actions?action=email_account_profile` that allow you to run action related to the given resource.

As mentioned above you can use the "snake case" of the class name as action's name in the uri parameter. If you want customize this value you can pass your custom name as first argument of your action constructor:

```php
/**
 * Get the actions available for the resource.
 *
 * @param  \Illuminate\Http\Request $request
 * @return array
 */
public static function actions(Request $request)
{
    return [
        // Run action using "/users/actions?action=email-profile
        new EmailAccountProfile('email-profile'),
    ];
}
```

## Authorization

If you would like to only expose a given action to certain users, you may chain the `canRun` method onto your action registration. The `canRun` method accepts a Closure which should return `true` or `false`. The Closure will receive the incoming HTTP request as well as the model the user would like to run the action against:

```php
/**
 * Get the actions available for the resource.
 *
 * @param  \Illuminate\Http\Request $request
 * @return array
 */
public static function actions(Request $request)
{
    return [
        (new EmailAccountProfile)
        	->canRun(function ($request, $model){
        		return $request->user()->can('emailAnyAccountProfile', $model);
        	}),
    ];
}
```

