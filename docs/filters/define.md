# Defining Filter

To get started, you may use the `carisma:filter` Artisan command. By default, Carisma will place newly generated filters in the `app/Carisma/Fitlers` directory:

```shell
php artisan carisma:filter MostValuableUsers
```

In the filter class generated by Carisma the `query` method is responsible for building the Eloquent query that is needed to retrieve the desired data, while the `fields` method returns an array of fields that should be displayed when viewing the lens.

To learn more, let's take a look at a complete lens definition that displays users and their lifetime revenue:

```php
<?php

namespace App\Carisma\Filters;

use Illuminate\Http\Request;
use Carisma\Fields\Field;
use Carisma\Filters\Filter;
use Illuminate\Support\Facades\DB;
use Carisma\Http\Requests\FilterRequest;

class MostValuableUsers extends Filter
{
    /**
     * Get the query builder / paginator for the filter.
     *
     * @param  \Carisma\Http\Requests\FilterRequest  $request
     * @param  \Illuminate\Database\Eloquent\Builder  $query
     * @return mixed
     */
    public static function query(FilterRequest $request, $query)
    {
        return $request->withOrdering($request->withFilters(
            $query->select(self::columns())
                  ->join('licenses', 'users.id', '=', 'licenses.user_id')
                  ->orderBy('revenue', 'desc')
                  ->groupBy('users.id', 'users.name')
        ));
    }

    /**
     * Get the columns that should be selected.
     *
     * @return array
     */
    protected static function columns()
    {
        return [
            'users.id',
            'users.name',
            DB::raw('sum(licenses.price) as revenue'),
        ];
    }

    /**
     * Get the fields available to the filter.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return array
     */
    public function fields(Request $request)
    {
        return [
            Field::make('id'),
            Field::make('name'),

            Field::make('revenue')
            	->resolveUsing(function ($value) {
                    return '$'.number_format($value, 2);
                }),
        ];
    }
}
```

> {info} Columns Method
>
> In this example, the `columns` method has been extracted from the `query` method for readability. It is not "required" and is not a "feature" of lenses.

As you can see in the example above, the `query` method has full control of the Eloquent query used to retrieve the data. The `fields` method may leverage any of Carisma's fields in order to appropriately display the data retrieved by the query.
